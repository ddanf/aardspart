<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, June 08, 2011, 10:50 PM -->
<!-- MuClient version 4.31 -->

<!-- Plugin "smoothTick" generated by Plugin Wizard -->

<muclient>
<plugin
   name="smoothTick"
   author="Spartacus"
   id="f64e84495f161a3c1b2f640c"
   language="Lua"
   purpose="a better tick timer"
   save_state="y"
   date_written="2011-06-08 10:48:38"
   requires="4.73"
   version="1.0"
   >
</plugin>

<!--  Timers  -->

<timers>
  <timer
   enabled="y"
   at_time="n"
   second="0.100"
   send_to="12"
   >
  <send>
    last_tick = last_tick or os.clock ()
    s = os.clock() - last_tick
    if s &lt;= 30 then
      --Note(30-s, ' seconds to tick')
      WindowRectOp (win, miniwin.rect_fill, 0, 0, 0, 0, bgColor)
      drawMenuHandle()
      drawFace()
      -- df2()
      drawHand(s)
      winTitle()
      local digits = string.format('%02d',round(30-s))
      WindowText(win, 'fDigit', digits, (WindowInfo(win, 3) / 2 - WindowTextWidth(win, 'fDigit', digits, false) / 2) + 1, 0.65 * WindowInfo(win, 4), 0, 0, textColor, false)
      WindowShow(win, true)
    else
      local digits = string.format('%02d',round(30-s))
      local tmpColor
      local l = round(10.0*(30-s))/10.0
      if math.abs(l) &gt;= math.abs(lateThresh) and math.abs(l) &lt; math.abs(discThresh) then
        tmpColor = lateColor
      elseif math.abs(l) &gt;= math.abs(discThresh) then
        tmpColor = discColor
      else
        tmpColor = textColor
      end
      WindowText(win, 'fDigit', digits, (WindowInfo(win, 3) / 2 - WindowTextWidth(win, 'fDigit', digits, false) / 2) + 1, 0.65 * WindowInfo(win, 4), 0, 0, tmpColor, false)
      -- WindowShow(win, true)
      Redraw()
    end
  </send>
  </timer>
</timers>

<script>
<![CDATA[

require "serialize"

local handlers = {}

function df2()
  res = WindowCircleOp(win, 1,  -- window, action
                       cx - 4 - 52, cy + 6 - 52, cx + 5 + 52, cy + 15 + 52, -- left, top, right, bottom
                       markColor, 512, 1, -- penColor, penStyle, penWidth
                       markColor, 1,  -- brushColor, brushStyle
                       0, 0, 0, 0)  -- extras
  res = WindowCircleOp(win, 1, cx - 4, cy + 6, cx + 5, cy + 15, pinColor, 0, 1, 0, 0, 0, 0)
end

function trim(s)
  return (s:gsub("^%s*(.-)%s*$", "%1"))
end

function OnPluginTelnetOption (option)
   if option == string.char (101,1) then
      -- last_tick = os.time()
      last_tick = os.clock()
      -- SetStatus ("Time to tick: " .. (last_tick + 30) - os.time ())
   end -- if
end -- function

function OnPluginInstall ()
  setDefaults()
  loadState()
  -- if disabled last time, stay disabled
  if GetVariable ("enabled") == "false" then
    ColourNote ("yellow", "", "Warning: Plugin " .. GetPluginName ().. " is currently disabled.")
    check (EnablePlugin(GetPluginID (), false))
    return
  else
    showTicker()
  end -- they didn't enable us last time  
end -- OnPluginInstall

-- pull in telnet option handling
dofile (GetPluginInfo (GetPluginID (), 20) .. "telnet_options.lua")

function OnPluginDisable ()
  setDefaults()
  OnPluginSaveState()
  WindowDelete(win)
end -- OnPluginSaveState
  
function OnPluginEnable ()
  setDefaults()
  loadState()
  showTicker()
end -- OnPluginEnable

function OnPluginSaveState ()
  if win == nil then setDefaults() end
  if WindowInfo(win, 7) ~= nil then
    SetVariable ("enabled", tostring (GetPluginInfo (GetPluginID (), 17)))
    SetVariable ("lay", WindowInfo(win, 7))
    SetVariable ("flags", WindowInfo(win, 8))
    SetVariable ("posx", WindowInfo(win, 10))
    SetVariable ("posy", WindowInfo(win, 11))
    SetVariable ("zord", WindowInfo(win, 22))
  end
  if bgColor ~= nil then
    SetVariable ("bgColor", bgColor)
    SetVariable ("pinColor", pinColor)
    SetVariable ("faceColor", faceColor)
    SetVariable ("handColor", handColor)
    SetVariable ("markColor", markColor)
    SetVariable ("menuColor", menuColor)
    SetVariable ("textColor", textColor)
    SetVariable ("titleColor", titleColor)
    SetVariable ("lateThresh", lateThresh)
    SetVariable ("discThresh", discThresh)
    SetVariable ("lateColor", lateColor)
    SetVariable ("discColor", discColor)
    SetVariable ("facetCount", facetCount)
  end
  if titleFont ~= nil then
    SetVariable ("titleFont", serialize.save("titleFont", titleFont))
  end
    if digitFont ~= nil then
    SetVariable ("digitFont", serialize.save("digitFont", digitFont))
  end
  if facetFont ~= nil then
    SetVariable ("facetFont", serialize.save("facetFont", facetFont))
  end
end -- OnPluginSaveState

function loadState ()
  lay = tonumber(GetVariable ("lay")) or 0
  flags = tonumber(GetVariable ("flags")) or 0
  bgColor = tonumber(GetVariable ("bgColor")) or ColourNameToRGB("black")
  pinColor = tonumber(GetVariable ("pinColor")) or ColourNameToRGB("deepskyblue")
  faceColor = tonumber(GetVariable ("faceColor")) or bgColor
  handColor = tonumber(GetVariable ("handColor")) or ColourNameToRGB("red")
  markColor = tonumber(GetVariable ("markColor")) or ColourNameToRGB("deepskyblue")
  menuColor = tonumber(GetVariable ("menuColor")) or ColourNameToRGB("gray")
  textColor = tonumber(GetVariable ("textColor")) or ColourNameToRGB("lime")
  titleColor = tonumber(GetVariable ("titleColor")) or ColourNameToRGB("white")
  
  lateThresh = tonumber(GetVariable ("lateThresh")) or 0.3
  discThresh = tonumber(GetVariable ("discThresh")) or 2.0
  lateColor = GetVariable ("lateColor") or ColourNameToRGB("yellow")
  discColor = GetVariable ("discColor") or ColourNameToRGB("orange")
  
  facetCount = GetVariable ("facetCount") or 12
  
  posx = tonumber(GetVariable ("posx")) or 100
  posy = tonumber(GetVariable ("posy")) or 100
  zord = tonumber(GetVariable ("zord")) or 1200
  
  local t = GetVariable("titleFont")
  local d = GetVariable("digitFont")
  local f = GetVariable("facetFont")
  -- this should set our font variables
  r = t ~= nil and loadstring(t)()
  r = d ~= nil and loadstring(d)()
  r = f ~= nil and loadstring(f)()
  
  --Note("Placing window '", win, "' at (", posx, ", ", posy, ")")
  --WindowPosition(win, posx, posy, 0, setbit(flags, 2))
  WindowSetZOrder(win, zord)
end --loadState

function setDefaults()
  cx = 60 -- center X
  cy = 50 -- center Y

  pid = GetPluginID() or '000NotAPlugin000'
  win = pid .. '_' .. 'ticker'
end -- setDefaults

function loadFont(id, f, ds)
  --Trebuchet MS
  local nm, sz, bl, it, ul, so
  if f ~= nil then
    nm, sz, bl, it, ul, so = f.name, f.size, f.bold, f.italic, f.underline, f.strikeout
  else
    nm, sz, bl, it, ul, so = '-NoFont', ds, false, false, false, false
  end
  WindowFont (win, id, nm, sz, bl, it, ul, so) -- define font
end -- loadFont

function showTicker()
  posx = tonumber(GetVariable('posx')) or 250
  posy = tonumber(GetVariable('posy')) or 250
  flags = tonumber(GetVariable('flags')) or 6

  x = WindowCreate(win, posx, posy, 121, 121, 12, setbit(flags, 2), bgColor)
  WindowSetZOrder(win, 1200)
  WindowShow(win, true)
  
  loadFont('fTitle', titleFont, 8)
  loadFont('fDigit', digitFont, 14)
  loadFont('fFacet', facetFont, 8)
  
  winTitle()
  drawFace()
  
  -- set up the drag handler
  we = handlers.new(win)
  WindowAddHotspot(win, "hs1",  
                   0, 0, 120, 120,   -- rectangle
                   "",   -- MouseOver
                   "",   -- CancelMouseOver
                   "we.mousedown",
                   "we.cancelmousedown", 
                   "we.mouseup", 
                   "Click to drag this window.",  -- tooltip text
                   1, 0)  -- hand cursor

  WindowAddHotspot(win, "0hs",  
                   0, 0, 20, 20,   -- rectangle
                   "",   -- MouseOver
                   "",   -- CancelMouseOver
                   "",
                   "", 
                   "showConfigMenu", 
                   "Click to configure timer",  -- tooltip text
                   1, 0)  -- hand cursor
  
  WindowDragHandler (win, "hs1", "we.dragmove", "we.dragrelease", 0)
end --showTicker

function showConfigMenu()
  OnPluginSaveState()
  local tCheck
  if bgColor == WindowInfo(win, 9) and hasbit(WindowInfo(win, 8), 4) then
    tCheck = '+'
  else
    tCheck = ''
  end
  local mStr = '!>Font | Title | Face | Digital | < | ' ..
               tCheck .. 'Transparent | ' ..
               '>Colors | Background | Center pin | ^Face | Hand | Marks | Menu handle | Digital | Title | Late | Disconnected | < |' ..
               ' - | Late Threshold (' .. math.abs(lateThresh) .. ') | Disc Threshold (' .. math.abs(discThresh) .. ') | # of Facets (' .. math.abs(facetCount) .. ') |' ..
               ' - | ^Bring to Front | ^Send to Back |' ..
               ' - | ^Help'
  local res = tonumber(WindowMenu(win, 5, 5, mStr)) or -1

  if res < 1 then
    return
  elseif res == 1 then
    local n, s, c = fontDetails(titleFont)
    titleFont = utils.fontpicker(n, s, c)
    loadFont('fTitle', titleFont, 8)
  elseif res == 2 then
    local n, s, c = fontDetails(facetFont)
    facetFont = utils.fontpicker(n, s, c)
    loadFont('fFacet', facetFont, 8)
  elseif res == 3 then
    local n, s, c = fontDetails(digitFont)
    digitFont = utils.fontpicker(n, s, c)
    loadFont('fDigit', digitFont, 14)
  elseif res == 4 then
    local flags = WindowInfo(win, 8)
    if tCheck == '+' then
      loadState()
      flags = clearbit(flags, 4)
      WindowPosition(win, posx, posy, 0, setbit(flags, 2))
    else
      flags = setbit(flags, 4)
      bgColor = WindowInfo(win, 9)
      WindowPosition(win, posx, posy, 0, setbit(flags, 2))
    end
  elseif res == 5 then
    bgColor = getColor(bgColor)
  elseif res == 6 then
    pinColor = getColor(pinColor)
  elseif res == 'face' then  -- not currently selectable
    faceColor = getColor(faceColor)
  elseif res == 7 then
    handColor = getColor(handColor)
  elseif res == 8 then
    markColor = getColor(markColor)
  elseif res == 9 then
    menuColor = getColor(menuColor)
  elseif res == 10 then
    textColor = getColor(textColor)
  elseif res == 11 then
    titleColor = getColor(titleColor)
  elseif res == 12 then
    lateColor = getColor(lateColor)
  elseif res == 13 then
    discColor = getColor(discColor)
  elseif res == 14 then
    local msg = "Please enter the time in seconds before a tick should be considered late."
    local title = "late tick threshold"
    lateThresh = getNumber(msg, title, lateThresh) or lateThresh
  elseif res == 15 then
    local msg = "Please enter the time in seconds before a late tick should be considered a disconnect."
    local title = "disconnect threshold"
    discThresh = getNumber(msg, title, discThresh) or discThresh
  elseif res == 16 then
    local msg = "Please enter number of facets to draw on the clock face."
    local title = "facet count"
    facetCount = getNumber(msg, title, facetCount) or facetCount
  elseif res == 17 then
    -- showHelp()
  else -- unhandled menu option
    Note('Not yet implemented. (', res, ')')
  end
  OnPluginSaveState()
end --showConfigMenu

function fontDetails(f)
  if f ~= nil then
    return f.name, f.size, f.color
  else
    return '-NoFont-', 8, 0
  end
end --fontDetails

function getNumber(msg, title, def)
  return utils.inputbox(msg, title, def, nil, nil, { validate = function (n)
                                                                        if tonumber(n) ~= nil then
                                                                          return true
                                                                        else
                                                                          return false
                                                                        end
                                                                      end
                                                          })
end --getNumber

function getFont(f)
  local n = utils.fontpicker(f.name, f.colour, f.size)
  if n == nil then
    return f
  else
    return n
  end
end --getFont

function getColor(c)
  local newColor = PickColour (c)
  if newcolor ~= -1 then
    c = newColor
  end
  return c
end --getColor

function round(v)
    local r = 0
    if type(v) == 'number' then
        i, f = math.modf(v)
        if f > 0.5 then
            r = i + 1
        else
            r = i
        end
    end
    return r
end --round

function drawFace()
    local r = 54
    local dpd = 360 / facetCount -- degrees per mark on the clock face
    local cx = WindowInfo(win, 3)/2 + 1
    local cy = WindowInfo(win, 4)/2 + 1
    
    markSize = 2
    d = 360
    fmt = '(sin, cos)=(%1.3f, %1.3f)  (x, y)=(%d, %d)'
    local size
    while d >= dpd do
        local s = math.sin(2 * math.pi * (360 - d) / 360)
        local c = math.cos(2 * math.pi * (360 - d) / 360)
        
        --if d == 0 then 
        --elseif d == 180 then
        --elseif d % 90 == 0 then
        --elseif d % 30 == 0 then
        --end
        x1 = round(cx - r * s)
        y1 = round(cy - r * c)
        x2 = round(cx + (r + markSize) * s)
        y2 = round(cy + (r + markSize) * c)
        --WindowLine(win, x1, y1, x2, y2, markColor, 0, 2)
        WindowCircleOp(win, 1, x1-markSize, y1-markSize, x1+markSize, y1+markSize, markColor, 0, 1, 0, 0, 0, 0)
        -- if you're gonna use text for the marks, you havta offset based on
        -- the font.  I don't wanna do this right now...
        -- res = WindowText(win, 'fFacet', '.', x1, y1, 0, 0, markColor, false)
        d = d - dpd
    end
    -- res = WindowCircleOp(win, 1, cx - 4, cy + 8, cx + 5, cy + 17, pinColor, 0, 1, 0, 0, 0, 0)
    r2 = 8
    -- little circle
    res = WindowCircleOp(win, 1, cx - r2, cy - r2, cx + r2, cy + r2, pinColor, 0, 1, 0, 0, 0, 0)
    -- drawX()
end --drawFace

function drawX()
  WindowLine(win, 2, 2, 119, 119, handColor, 256, 1)
  WindowLine(win, 2, 119, 119, 2, handColor, 256, 1)
end --drawX

function drawHand(t)
    local spt = 30.0  -- seconds per tick - divisions in the circle
    local sups = 10.0 -- sub-units per second
    local r = 50 -- radius of the hand
    
    a = 2 * math.pi * (spt - t) / spt  -- angle of the line
    local s = math.sin(a)
    local c = math.cos(a)
    
    -- for a needle that extends past center
    -- x1 = 1+round(cx + 0.1 * r * s)
    -- y1 = 10 + round(cy + 0.1 * r * c)
    
    -- for a needle that goes to center
    -- x1 = cx
    -- y1 = 10+cy
    
    -- for a needle that does not reach center
    x1 = 1+round(cx - 0.3 * r * s)
    y1 = 10 + round(cy - 0.3 * r * c)
    
    x2 = 1+round(cx - 0.9 * r * s)
    y2 = 10 + round(cy - 0.9 * r * c)
    
    WindowLine(win, x1, y1, x2, y2, handColor, 256, 2)
end --drawHand

function winTitle()
  local title = 'Tick Timer'
  res = WindowText(win, 'fTitle', title, (WindowInfo(win, 3) / 2 - WindowTextWidth(win, 'fTitle', title, false) / 2) + 1, 0.25 * WindowInfo(win, 4), 0, 0, titleColor, false)
end

function drawMenuHandle()
  WindowPolygon(win, "4,4,18,4,11,14" , menuColor, 6, 1, menuColor, 8 , true, false)
end

function testHand()
    local t=0
    while t<30 do
        drawHand(t)
        t = t + 1
    end
end

function showHelp()
end --showHelp
-------------------------------------------------------------------------------
-- miniwindow event handler functions
-------------------------------------------------------------------------------
function handlers.new(wName)
  --Note('initializing handlers.  self = ', handlers)
  handlers.win = wName
  --for k, v in pairs(handlers) do
  --  Note('  ', k, ' = ', v)
  --end
  return handlers
end -- init

function handlers.mousedown(flags, hotspot_id)
  startx, starty = WindowInfo (handlers.win, 14), WindowInfo (handlers.win, 15)
  WindowSetZOrder(handlers.win, 1200)
  -- print ("we moused down on hotspot " .. hotspot_id)
end -- mousedown

function handlers.cancelmousedown(flags, hotspot_id)
  -- print ("we cancelled moused down for hotspot " .. hotspot_id)
end -- cancelmousedown

function handlers.mouseup(flags, hotspot_id)
  if hasbit(flags, miniwin.hotspot_got_rh_mouse) then
    showConfigMenu()
  end
  -- print ("we moused up on hotspot " .. hotspot_id)
end -- mouseup

function handlers.dragmove(flags, hotspot_id)
  if hasbit(flags, miniwin.hotspot_got_rh_mouse) then
    -- don't drag on right-click
    return
  end
  local posx, posy, flags = WindowInfo (handlers.win, 17),
                     WindowInfo (handlers.win, 18),
                     WindowInfo(handlers.win, 8)

  -- print ("moved to position", posx, posy)
  -- move the window to the new location
  WindowPosition(handlers.win, posx - startx, posy - starty, 0, setbit(flags, 2));
  
  -- change the mouse cursor shape appropriately
  if posx < 0 or posx > GetInfo (281) or
     posy < 0 or posy > GetInfo (280) then
    check (SetCursor ( 11))   -- X cursor
  else
    check (SetCursor ( 1))   -- hand cursor
  end -- if
  
end -- dragmove

function handlers.dragrelease(flags, hotspot_id)
  -- print ("mouse drag release for " .. hotspot_id)
  -- print ("released at position", WindowInfo (win, 17), WindowInfo (win, 18))
  -- print ("moved to position", posx, posy)
  -- the window was just moved, so this seems like a good time to save state
  OnPluginSaveState()
end -- dragrelease
-------------------------------------------------------------------------------
-- general utility functions
-------------------------------------------------------------------------------

function bit(p)
  return 2 ^ (p - 1)  -- 1-based indexing
end

-- Typical call:  if hasbit(x, bit(3)) then ...
function hasbit(x, p)
  return x % (p + p) >= p       
end

function setbit(x, p)
  return hasbit(x, p) and x or x + p
end

function clearbit(x, p)
  return hasbit(x, p) and x - p or x
end

]]>
</script>
</muclient>
