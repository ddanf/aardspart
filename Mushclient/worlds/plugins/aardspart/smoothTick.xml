<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, June 08, 2011, 10:50 PM -->
<!-- MuClient version 4.31 -->

<!-- Plugin "smoothTick" generated by Plugin Wizard -->

<muclient>
<plugin
   name="smoothTick"
   author="Spartacus"
   id="f64e84495f161a3c1b2f640c"
   language="Lua"
   purpose="a better tick timer"
   save_state="y"
   date_written="2011-06-08 10:48:38"
   requires="4.73"
   version="2.2"
   >
</plugin>

<!--  Timers  -->

<timers>
  <timer
   enabled="y"
   at_time="n"
   second="0.100"
   send_to="12"
   >
  <send>
    last_tick = last_tick or os.clock ()
    s = os.clock() - last_tick
    WindowRectOp (win, miniwin.rect_fill, 0, 0, 0, 0, bgColor)
    drawMenuHandle()
    drawFace()
    drawHand(math.min(30,s))
    winTitle()
    if s &lt;= 30 then
      --Note(30-s, ' seconds to tick')
      -- df2()
      local digits = string.format('%02d',round(30-s))
      WindowText(win, 'fDigit', digits, (WindowInfo(win, 3) / 2 - WindowTextWidth(win, 'fDigit', digits, false) / 2) + 1, 0.65 * WindowInfo(win, 4), 0, 0, textColor, false)
      WindowShow(win, true)
    else
      local digits = string.format('%02d',round(30-s))
      local tmpColor
      local l = round(10.0*(30-s))/10.0
      if math.abs(l) &gt;= math.abs(lateThresh) and math.abs(l) &lt; math.abs(discThresh) then
        tmpColor = lateColor
      elseif math.abs(l) &gt;= math.abs(discThresh) then
        tmpColor = discColor
      else
        tmpColor = textColor
      end
      WindowText(win, 'fDigit', digits, (WindowInfo(win, 3) / 2 - WindowTextWidth(win, 'fDigit', digits, false) / 2) + 1, 0.65 * WindowInfo(win, 4), 0, 0, tmpColor, false)
      -- WindowShow(win, true)
      Redraw()
    end
  </send>
  </timer>
</timers>

<script>
<![CDATA[

require "serialize"
require "worlds\\plugins\\aardspart\\lua\\spartbits"
require "worlds\\plugins\\aardspart\\lua\\ezwin"

-- local handlers = {}

function df2()
  res = WindowCircleOp(win, 1,  -- window, action
                       cx - 4 - 52, cy + 6 - 52, cx + 5 + 52, cy + 15 + 52, -- left, top, right, bottom
                       markColor, 512, 1, -- penColor, penStyle, penWidth
                       markColor, 1,  -- brushColor, brushStyle
                       0, 0, 0, 0)  -- extras
  res = WindowCircleOp(win, 1, cx - 4, cy + 6, cx + 5, cy + 15, pinColor, 0, 1, 0, 0, 0, 0)
end

function trim(s)
  return (s:gsub("^%s*(.-)%s*$", "%1"))
end

function OnPluginTelnetOption (option)
   if option == string.char (101,1) then
      -- last_tick = os.time()
      last_tick = os.clock()
      -- SetStatus ("Time to tick: " .. (last_tick + 30) - os.time ())
   end -- if
end -- function

function OnPluginInstall ()
  setDefaults()
  loadState()
  -- if disabled last time, stay disabled
  if GetVariable ("enabled") == "false" then
    ColourNote ("yellow", "", "Warning: Plugin " .. GetPluginName ().. " is currently disabled.")
    check (EnablePlugin(GetPluginID (), false))
    return
  else
    showTicker()
  end -- they didn't enable us last time  
end -- OnPluginInstall

-- pull in telnet option handling
local paths = { GetPluginInfo(GetPluginID (), 20) .. "telnet_options.lua",
                GetInfo(60) .. "Aardwolf\\telnet_options.lua",
                GetInfo(60) .. "telnet_options.lua",
                GetInfo(59) .. "telnet_options.lua" }
local tnOpFile
local tnOpFound = false
local i = 1

while not tnOpFound and i < #paths do
  tnOpFile = paths[i]
  tnOpFound = utils.readdir(tnOpFile)
  i = i + 1
end -- while not tnOpFound

if not tnOpFound then
  Note("To use smoothTick, you must have telnet_options.lua installed in one of the following paths:")
  for _, p in pairs(paths) do Note("    ", p) end
  Note()
  Hyperlink("http://www.gammon.com.au/mushclient/plugins/Aardwolf/telnet_options.lua",
            "Click here to download telnet_options.lua",
            "click to download telnet_options.lua",
            "white", "red",
            true)
  Note()
  ColourNote("yellow","black","Disabling smoothTick.")
  ColourNote("yellow","black","To turn smoothTick on after installing telnet_options.lua,")
  ColourNote("yellow","black","press Ctrl-Shift-P, select smoothTick, and click on the 'Enable' button.")
  EnablePlugin(GetPluginID(), false)
end --
dofile (tnOpFile)

function OnPluginDisable ()
  setDefaults()
  OnPluginSaveState()
  WindowDelete(win)
end -- OnPluginSaveState
  
function OnPluginEnable ()
  setDefaults()
  loadState()
  showTicker()
end -- OnPluginEnable

function OnPluginSaveState ()
  if win == nil then setDefaults() end
  if WindowInfo(win, 7) ~= nil then
    SetVariable ("enabled", tostring (GetPluginInfo (GetPluginID (), 17)))
    SetVariable ("lay", WindowInfo(win, 7))
    SetVariable ("flags", WindowInfo(win, 8))
    SetVariable ("posx", WindowInfo(win, 10))
    SetVariable ("posy", WindowInfo(win, 11))
    SetVariable ("zord", WindowInfo(win, 22))
  end
  if bgColor ~= nil then
    SetVariable ("bgColor", bgColor)
    SetVariable ("pinColor", pinColor)
    SetVariable ("faceColor", faceColor)
    SetVariable ("facePattern", facePattern)
    SetVariable ("handColor", handColor)
    SetVariable ("markColor", markColor)
    SetVariable ("menuColor", menuColor)
    SetVariable ("textColor", textColor)
    SetVariable ("titleColor", titleColor)
    SetVariable ("lateThresh", lateThresh)
    SetVariable ("discThresh", discThresh)
    SetVariable ("lateColor", lateColor)
    SetVariable ("discColor", discColor)
    SetVariable ("facetCount", facetCount)
  end
  if titleFont ~= nil then
    SetVariable ("titleFont", serialize.save("titleFont", titleFont))
  end
    if digitFont ~= nil then
    SetVariable ("digitFont", serialize.save("digitFont", digitFont))
  end
  if facetFont ~= nil then
    SetVariable ("facetFont", serialize.save("facetFont", facetFont))
  end
end -- OnPluginSaveState

function loadState ()
  lay = tonumber(GetVariable ("lay")) or 0
  flags = tonumber(GetVariable ("flags")) or 0
  bgColor = tonumber(GetVariable ("bgColor")) or ColourNameToRGB("black")
  pinColor = tonumber(GetVariable ("pinColor")) or ColourNameToRGB("deepskyblue")
  faceColor = tonumber(GetVariable ("faceColor")) or ColourNameToRGB("deepskyblue")
  facePattern = tonumber(GetVariable ("facePattern")) or 1
  handColor = tonumber(GetVariable ("handColor")) or ColourNameToRGB("red")
  markColor = tonumber(GetVariable ("markColor")) or ColourNameToRGB("deepskyblue")
  menuColor = tonumber(GetVariable ("menuColor")) or ColourNameToRGB("gray")
  textColor = tonumber(GetVariable ("textColor")) or ColourNameToRGB("lime")
  titleColor = tonumber(GetVariable ("titleColor")) or ColourNameToRGB("white")
  
  lateThresh = tonumber(GetVariable ("lateThresh")) or 0.3
  discThresh = tonumber(GetVariable ("discThresh")) or 2.0
  lateColor = GetVariable ("lateColor") or ColourNameToRGB("yellow")
  discColor = GetVariable ("discColor") or ColourNameToRGB("orange")
  
  facetCount = GetVariable ("facetCount") or 12
  
  posx = tonumber(GetVariable ("posx")) or 100
  posy = tonumber(GetVariable ("posy")) or 100
  zord = tonumber(GetVariable ("zord")) or 1200
  
  local t = GetVariable("titleFont")
  local d = GetVariable("digitFont")
  local f = GetVariable("facetFont")
  -- this should set our font variables
  r = t ~= nil and loadstring(t)()
  r = d ~= nil and loadstring(d)()
  r = f ~= nil and loadstring(f)()
  
  --Note("Placing window '", win, "' at (", posx, ", ", posy, ")")
  --WindowPosition(win, posx, posy, 0, setbit(flags, 2))
  WindowSetZOrder(win, zord)
end --loadState

function setDefaults()
  cx = 60 -- center X
  cy = 50 -- center Y

  pid = GetPluginID() or '000NotAPlugin000'
  win = pid .. '_' .. 'ticker'
end -- setDefaults

function restoreDefaults()
  lay =  0
  flags = 0
  bgColor = ColourNameToRGB("black")
  pinColor = ColourNameToRGB("deepskyblue")
  faceColor = ColourNameToRGB("deepskyblue")
  facePattern = 1
  handColor = ColourNameToRGB("red")
  markColor = ColourNameToRGB("deepskyblue")
  menuColor = ColourNameToRGB("gray")
  textColor = ColourNameToRGB("lime")
  titleColor = ColourNameToRGB("white")
  
  lateThresh = 0.3
  discThresh = 2.0
  lateColor = ColourNameToRGB("yellow")
  discColor = ColourNameToRGB("orange")
  
  facetCount = 12
  
  posx = 100
  posy = 100
  zord = 1200
  
  titleFont = {}
    titleFont.bold = 0
    titleFont.colour = 0
    titleFont.style = "Regular"
    titleFont.charset = 0
    titleFont.name = "Rage Italic"
    titleFont.italic = 0
    titleFont.underline = 0
    titleFont.strikeout = 0
    titleFont.size = 14
  digitFont = {}
    digitFont.bold = 0
    digitFont.colour = 0
    digitFont.style = "Regular"
    digitFont.size = 18
    digitFont.italic = 0
    digitFont.charset = 0
    digitFont.underline = 0
    digitFont.strikeout = 0
    digitFont.name = "Quartz"
  facetFont = {}
    facetFont.bold = 0
    facetFont.colour = 0
    facetFont.style = "Regular"
    facetFont.size = 12
    facetFont.italic = 0
    facetFont.charset = 0
    facetFont.underline = 0
    facetFont.strikeout = 0
    facetFont.name = "Lucida Console"
  WindowSetZOrder(win, zord)
end --restoreDefaults

function showTicker()
  posx = tonumber(GetVariable('posx')) or 250
  posy = tonumber(GetVariable('posy')) or 250
  flags = tonumber(GetVariable('flags')) or 6

  stWin = ezwin.new(win, posx, posy, 121, 121, 12, setbit(flags, 2), bgColor, titleColor, 'stWin')
  WindowSetZOrder(win, 1200)
  WindowShow(win, true)
  
  stWin.loadFont('fTitle', titleFont, 8)
  stWin.loadFont('fDigit', digitFont, 14)
  stWin.loadFont('fFacet', facetFont, 8)
  
  winTitle()
  drawFace()
   
  stWin.addDrag()
  stWin.createMenu()
  setupMenu(stWin)
end --showTicker

function setupMenu(window)
  local menu = window.menu
      -- a menu item table should contain the following elements:
      --   displayName = text to be displayed on the menu.
      --   enabled     = boolean true to enable, false to disable
      --   checked     = function or variable to determine whether or not the
      --                 item is checked.  true = checked, false = unchecked.
      --                 If a boolean value is supplied, then the state can
      --                 not be changed by the menu.
      --   callback    = function to call when the menu item is selected
      --   submenu     = boolean true if future items should be children of this
      --                 item.  true with nil display name to end a submenu.
      -- if item is nil, then a separator will be added
      -- if displayName is nil and submenu is true the current submenu will end
  menu.add({displayName = 'Font', enabled = true, submenu = true})
  menu.add({displayName = 'Title', enabled = true, callback = function ()
                                                                    local n, s, c = fontDetails(titleFont)
                                                                    titleFont = utils.fontpicker(n, s, c)
                                                                    window.loadFont('fTitle', titleFont, 8)
                                                                 end})
  menu.add({displayName = 'Face', enabled = true, callback = function ()
                                                                    local n, s, c = fontDetails(facetFont)
                                                                    facetFont = utils.fontpicker(n, s, c)
                                                                    window.loadFont('fFacet', facetFont, 8)
                                                                 end})
  menu.add({displayName = 'Digital', enabled = true, callback = function ()
                                                                    local n, s, c = fontDetails(digitFont)
                                                                    digitFont = utils.fontpicker(n, s, c)
                                                                    window.loadFont('fDigit', digitFont, 8)
                                                                 end})
  menu.add({displayName = nil, submenu = true}) -- end sub menu
  menu.add({displayName = 'Transparent', enabled = true,
               checked = function() return (bgColor == WindowInfo(win, 9) and hasbit(WindowInfo(win, 8), 4)) end,
               callback = function ()
                            local flags = WindowInfo(win, 8)
                            if hasbit(flags, 4) then bgColor = WindowInfo(win, 9) end
                            WindowPosition(win, WindowInfo(win,1), WindowInfo(win,2), 0, flipbit(flags, 4))
                          end})
  menu.add({displayName = 'Colors', enabled = true, submenu = true})
  menu.add({displayName = 'Background', enabled = true, callback = function() bgColor=getColor(bgColor) end})
  menu.add({displayName = 'Center Pin', enabled = true, callback = function() pinColor=getColor(pinColor) end})
  menu.add({displayName = 'Face', enabled = true, callback = function() faceColor=getColor(faceColor) end})
  menu.add({displayName = 'Hand', enabled = true, callback = function() handColor=getColor(handColor) end})
  menu.add({displayName = 'Marks', enabled = true, callback = function() markColor=getColor(markColor) end})
  menu.add({displayName = 'Menu Handle', enabled = true, callback = function() menuColor=getColor(menuColor) end})
  menu.add({displayName = 'Digital', enabled = true, callback = function() textColor=getColor(textColor) end})
  menu.add({displayName = 'Title', enabled = true, callback = function() titleColor=getColor(titleColor) end})
  menu.add({displayName = 'Late', enabled = true, callback = function() lateColor=getColor(lateColor) end})
  menu.add({displayName = 'Disconnected', enabled = true, callback = function() discColor=getColor(discColor) end})
  menu.add({displayName = nil, submenu = true}) -- end sub menu
  menu.add({displayName = 'Face Pattern', enabled = true, submenu = true})
  menu.add({displayName = 'solid', enabled = true, checked = function () return (facePattern == 0) end, callback = function () facePattern = 0 end})
  menu.add({displayName = 'none', enabled = true, checked = function () return (facePattern == 1) end, callback = function () facePattern = 1 end})
  menu.add({displayName = 'horizontal hatch', enabled = true, checked = function () return (facePattern == 2) end, callback = function () facePattern = 2 end})
  menu.add({displayName = 'vertical hatch', enabled = true, checked = function () return (facePattern == 3) end, callback = function () facePattern = 3 end})
  menu.add({displayName = 'forward diagonal', enabled = true, checked = function () return (facePattern == 4) end, callback = function () facePattern = 4 end})
  menu.add({displayName = 'backward diagonal', enabled = true, checked = function () return (facePattern == 5) end, callback = function () facePattern = 5 end})
  menu.add({displayName = 'cross hatch', enabled = true, checked = function () return (facePattern == 6) end, callback = function () facePattern = 6 end})
  menu.add({displayName = 'diagonal cross hatch', enabled = true, checked = function () return (facePattern == 7) end, callback = function () facePattern = 7 end})
  menu.add({displayName = 'fine fill', enabled = true, checked = function () return (facePattern == 8) end, callback = function () facePattern = 8 end})
  menu.add({displayName = 'medium fill', enabled = true, checked = function () return (facePattern == 9) end, callback = function () facePattern = 9 end})
  menu.add({displayName = 'coarse fill', enabled = true, checked = function () return (facePattern == 10) end, callback = function () facePattern = 10 end})
  menu.add({displayName = 'horizontal waves', enabled = true, checked = function () return (facePattern == 11) end, callback = function () facePattern = 11 end})
  menu.add({displayName = 'vertical waves', enabled = true, checked = function () return (facePattern == 12) end, callback = function () facePattern = 12 end})
  menu.add({displayName = nil, submenu = true}) -- end sub menu
  menu.add(nil) -- separator
  menu.add({displayName = 'Late Threshold', enabled = true, callback = function()
                                                                            local msg = "How long should a tick be overdue before considered late?  (seconds)"
                                                                            local title = "late tick threshold"
                                                                            lateThresh = getNumber(msg, title, lateThresh) or lateThresh
                                                                          end})
  menu.add({displayName = 'Disc Threshold', enabled = true, callback = function()
                                                                            local msg = "How long should a tick be overdue before considered disconnected?  (seconds)"
                                                                            local title = "disconnect threshold"
                                                                            discThresh = getNumber(msg, title, discThresh) or discThresh
                                                                          end})
  menu.add({displayName = '# of Facets', enabled = true, callback = function()
                                                                         local msg = "Please enter number of facets to draw on the clock face."
                                                                         local title = "facet count"
                                                                         facetCount = getNumber(msg, title, facetCount) or facetCount
                                                                       end })
  menu.add(nil) -- separator
  menu.add({displayName = 'Bring to Front', enabled = true, callback = function () window.bringToFront() end})
  menu.add({displayName = 'Send to Back', enabled = true, callback = function () window.sendToBack() end})
  menu.add(nil) -- separator
  menu.add({displayName = 'Restore Factory Defaults', enabled = true, callback = function () restoreDefaults() end})
  menu.add(nil) -- separator
  menu.add({displayName = 'Help', enabled = true, callback = function ()
                                                                    OpenBrowser('http://code.google.com/p/aardspart/wiki/smoothTick')
                                                                end})
  -- return cfgMenu
end

function fontDetails(f)
  if f ~= nil then
    return f.name, f.size, f.color
  else
    return '-NoFont-', 8, 0
  end
end --fontDetails

function getNumber(msg, title, def)
  return utils.inputbox(msg, title, def, nil, nil, { validate = function (n)
                                                                        if tonumber(n) ~= nil then
                                                                          return true
                                                                        else
                                                                          return false
                                                                        end
                                                                      end
                                                          })
end --getNumber

function getFont(f)
  local n = utils.fontpicker(f.name, f.colour, f.size)
  if n == nil then
    return f
  else
    return n
  end
end --getFont

function getColor(c)
  local newColor = PickColour (c)
  if newcolor ~= -1 then
    c = newColor
  end
  return c
end --getColor

function round(v)
    local r = 0
    if type(v) == 'number' then
        i, f = math.modf(v)
        if f > 0.5 then
            r = i + 1
        else
            r = i
        end
    end
    return r
end --round

function drawFace()
    local r = 54
    local dpd = 360 / facetCount -- degrees per mark on the clock face
    local cx = WindowInfo(win, 3)/2 + 1
    local cy = WindowInfo(win, 4)/2 + 1
    
    markSize = 2
    d = 360
    fmt = '(sin, cos)=(%1.3f, %1.3f)  (x, y)=(%d, %d)'
    local size
    while d >= dpd do
        local s = math.sin(2 * math.pi * (360 - d) / 360)
        local c = math.cos(2 * math.pi * (360 - d) / 360)
        
        --if d == 0 then 
        --elseif d == 180 then
        --elseif d % 90 == 0 then
        --elseif d % 30 == 0 then
        --end
        x1 = round(cx - r * s)
        y1 = round(cy - r * c)
        x2 = round(cx + (r + markSize) * s)
        y2 = round(cy + (r + markSize) * c)
        --WindowLine(win, x1, y1, x2, y2, markColor, 0, 2)
        WindowCircleOp(win, 1, x1-markSize, y1-markSize, x1+markSize, y1+markSize, markColor, 0, 1, 0, 0, 0, 0)
        -- if you're gonna use text for the marks, you havta offset based on
        -- the font.  I don't wanna do this right now...
        -- res = WindowText(win, 'fFacet', '.', x1, y1, 0, 0, markColor, false)
        d = d - dpd
    end
    r2 = 8
    -- big circle
    res = WindowCircleOp(win, 1, cx - (r-4), cy - (r-4), cx + (r-4), cy + (r-4), bgColor, 5, 0, faceColor, facePattern, 0, 0, 0, 0)
    -- little circle
    res = WindowCircleOp(win, 1, cx - r2, cy - r2, cx + r2, cy + r2, pinColor, 0, 1, faceColor, 1, 0, 0, 0, 0)
    -- drawX()
end --drawFace

function drawX()
  WindowLine(win, 2, 2, 119, 119, handColor, 256, 1)
  WindowLine(win, 2, 119, 119, 2, handColor, 256, 1)
end --drawX

function drawHand(t)
    local spt = 30.0  -- seconds per tick - divisions in the circle
    local sups = 10.0 -- sub-units per second
    local r = 50 -- radius of the hand
    
    a = 2 * math.pi * (spt - t) / spt  -- angle of the line
    local s = math.sin(a)
    local c = math.cos(a)
    
    -- for a needle that extends past center
    -- x1 = 1+round(cx + 0.1 * r * s)
    -- y1 = 10 + round(cy + 0.1 * r * c)
    
    -- for a needle that goes to center
    -- x1 = cx
    -- y1 = 10+cy
    
    -- for a needle that does not reach center
    x1 = 1+round(cx - 0.3 * r * s)
    y1 = 10 + round(cy - 0.3 * r * c)
    
    x2 = 1+round(cx - 0.9 * r * s)
    y2 = 10 + round(cy - 0.9 * r * c)
    
    WindowLine(win, x1, y1, x2, y2, handColor, 256, 2)
end --drawHand

function winTitle()
  local title = 'Smooth Tick'
  res = WindowText(win, 'fTitle', title, (WindowInfo(win, 3) / 2 - WindowTextWidth(win, 'fTitle', title, false) / 2) + 1, 0.25 * WindowInfo(win, 4), 0, 0, titleColor, false)
end

function drawMenuHandle()
  WindowPolygon(win, "4,4,18,4,11,14" , menuColor, 6, 1, menuColor, 8 , true, false)
end

function testHand()
    local t=0
    while t<30 do
        drawHand(t)
        t = t + 1
    end
end

function showHelp()
end --showHelp


]]>
</script>
</muclient>
